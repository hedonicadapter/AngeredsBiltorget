---
  import TagsContainer from '../components/TagsContainer.tsx';
  import CarsContainer from '../components/CarsContainer.jsx';
  import CurrentResultCount from '../components/CurrentResultCount.jsx';
  import ButtonsContainer from '../components/ButtonsContainer.jsx';
  import "../components/styles/showroom.css";
  import Layout from "../layouts/Layout.astro";
  import type Car from '../Models/Car';
  import {
    generateDummyCarData,
    getProductCount,
    getProductFiles,
    getProducts,
    upsertProduct,
  } from '../api';
  import { DocumentSnapshot } from 'firebase/firestore';

  // TODO: get initial cars here

  const count = await getProductCount();
---
<Layout>
  <section class="container flex flex-col items-center w-screen mx-auto">
    <search class=" gap-[calc(var--golden-ratio)*0.25em] sticky top-[var(--navbar-height)] w-full h-40 mb-10 flex flex-col">
      <ButtonsContainer client:load />
  
      <hr />
      <!-- TODO: not entirely responsive -->
      <div
        class="flex flex-row items-start justify-between tags-and-result-count-container"
      >
        <TagsContainer client:only/>
        <div class="results-count">
          <CurrentResultCount client:load/> /
          <span id="results-available">{count}</span> Resultat
        </div>
      </div>
    </search>
    <div class="w-full mt-[calc(var(--navbar-height)-4em)] pb-72">
      <CarsContainer client:load/>
    </div>
  </section>
</Layout>

  <script>
    import {
      generateDummyCarData,
      getProductCount,
      getProductFiles,
      getProducts,
      upsertProduct,
    } from '../api';
    import type Car from '../Models/Car';
    import { DocumentSnapshot } from 'firebase/firestore';

    const initializeScript = () => {
    // TODO: migrate to astro
    // TODO: fix formatting on all <script/>s

    let oldScrollY = 0;

    const filterContainer = document.querySelector(
      '.filter-container'
    ) as HTMLElement;
    const filterContainerRect = filterContainer?.getBoundingClientRect();
    filterContainer?.style.setProperty(
      '--original-position',
      `${filterContainerRect.top}px`
    );

    const carsContainer = document.querySelector('.cars-container') as HTMLElement;

    const setFilterContainerPosition = () => {
      const section = document.querySelector('section.container') as HTMLElement;
      const navbar = document.querySelector('.navbar-top') as HTMLElement;

      section?.style.setProperty('--navbar-height', `${navbar.offsetHeight}px`);
    };

    const redirectScrollY = (scrollIncrement = 100) => {
      const scrolledToBottom =
        window.scrollY + window.innerHeight === document.body.scrollHeight;
      const direction = window.scrollY > oldScrollY ? 'down' : 'up';

      if (scrolledToBottom) {
        if (direction === 'down')
          carsContainer.scrollBy({
            behavior: 'smooth',
            top: -scrollIncrement * 10,
          });
      }

      if (direction === 'up')
        carsContainer.scrollBy({ behavior: 'smooth', top: scrollIncrement * 10 });
    };

    const handleWindowScrollAttempt = (event: WheelEvent | KeyboardEvent) => {
      if (event instanceof WheelEvent) redirectScrollY( event.deltaY);
      else redirectScrollY();
    };

  window.addEventListener('scroll', setFilterContainerPosition);
  window.addEventListener('wheel', handleWindowScrollAttempt);
  window.addEventListener('keydown', (event: KeyboardEvent) => {
    if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
      handleWindowScrollAttempt(event);
    }
  });

  setFilterContainerPosition();
}

  document.addEventListener('astro:after-swap', initializeScript);
  initializeScript();
  </script>