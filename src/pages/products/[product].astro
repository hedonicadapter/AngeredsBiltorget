---
import {getProductFiles, getProducts} from '../../api';
import '../../components/styles/product.css'
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths(){
    const products = await getProducts(0, -1);

    return await Promise.all(products.map(async product => {
        const files = await getProductFiles(product.id);
        const productData = product.data();

        return {
            params: {product: product.id},
            props: {
                product: productData,
                files
            }
        }
    }));
}

const {product, files} = Astro.props;
if(!product) return Astro.redirect('/404');
console.log(product);

const mainImage = files.find(file => file.name.startsWith('thumbnail'));
---

<Layout>
    <section id="product-container" class="flex flex-col w-screen md:px-[14vw] h-screen pt-32 gap-5 p-16 md:flex-row md:justify-center md:gap-0 md:items-center justify-items-center text-on-bg-medium">
        <div class="flex flex-col gap-4 mt-12 md:order-2 md:flex-[1.75]">
            <div class="md:max-w-[40vw] aspect-square">
                <img class="object-contain w-full h-full md:overflow-visible md:z-[-20]" transition:name="thumbnail" src={mainImage?.url || '/images/volvo.webp'} alt={`${product.title || product.make + ' ' + product.model} (car)`}/>
            </div>
            <div class="flex flex-row w-screen overflow-x-auto md:w-auto h-36 md:h-20">{files.map(file=>(
                <div class="w-auto h-full overflow-hidden aspect-square"><img class="object-cover w-full h-full" src={file.url} alt={`${product.title || product.make + ' ' + product.model} (car)`}/></div>
            ))}
            </div>
        </div>

        <div class="md:order-1 md:flex-1 md:-mr-16 md:text-right md:z-10">
            <div class="flex flex-row items-baseline justify-between gap-1 md:justify-end pb-7">
                <div class="flex flex-col">
                    <h4 class="text-xl md:text-5xl md:pb-1 whitespace-nowrap">{product.title || product.make + ' ' + product.model}</h4>
                    <p class="text-sm text-on-bg-light">{product.price} SEK</p>
                </div>
                <p class="text-sm text-on-bg-medium">{product.year}</p>
            </div>

            <p class="text-base font-light text-on-bg-medium">{product.description}</p>
        </div>

        <div class="flex flex-col gap-5 md:order-3 md:flex-1 md:-ml-16 md:z-10">
            <div class="flex flex-col gap-6 px-5 py-4 -mx-5 rounded-lg md:mx-0 bg-surface-dark md:bg-transparent md:outline-0 md:p-0 text-on-bg-medium outline outline-outline outline-1 md:max-w-96">
                <div class="flex flex-row items-center justify-between">
                    <div class="flex flex-row gap-2"><div class="material-symbols-sharp text-on-bg-light">ev_charger</div><p class="my-auto text-xs uppercase text-on-bg-lightest">Drivmedel</p></div>
                    <p class="text-lg font-light">{product.fuelType}</p>
                </div>
                <div class="flex flex-row items-center justify-between">
                    <div class="flex flex-row gap-2"><div class="material-symbols-sharp text-on-bg-light">swap_driving_apps_wheel</div><p class="my-auto text-xs uppercase text-on-bg-lightest">Miltal</p></div>
                    <p class="text-lg font-light">{product.mileage}</p>
                </div>
                <div class="flex flex-row items-center justify-between">
                    <div class="flex flex-row gap-2"><div class="material-symbols-sharp text-on-bg-light">pin</div><p class="my-auto text-xs uppercase text-on-bg-lightest">Registreringsnummer</p></div>
                    <p class="text-lg font-light">{product.registrationNumber}</p>
                </div>
            </div>
        
            <div class="mt-7 md:mt-6">
                <h4 class="text-on-bg-lightest">Annat fint</h4>
                <div class="flex flex-row flex-wrap gap-6 mt-2 text-on-bg-light">
                    {!!product.extraFeatures && product.extraFeatures.length > 0 && 
                        product.extraFeatures?.map((feature:string)=>(
                            <div>{feature}</div>
                        ))
                    }
                </div>
            </div>
        </div>
        
    </section>

</Layout>